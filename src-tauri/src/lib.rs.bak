use tauri::{AppHandle, Manager};use tracing_subscriber::{fmt, EnvFilter};use std::sync::Mutex;

pub mod app;
pub mod entity;
pub mod process;
pub mod utils;

pub struct AppState {
    token: Mutex<String>,
}

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    fmt().with_env_filter(EnvFilter::from_default_env()).init();

    // 初始化配置服务
    if let Err(e) = crate::app::system::config_service::init_config_service() {
        tracing::error!("初始化配置服务失败: {}", e);
        // 继续执行，使用默认端口配置
    }

    let state = AppState {
        token: Mutex::new(String::new()),
    };

    tauri::Builder::default()
        .manage(state)
        .invoke_handler(tauri::generate_handler![
                        // Core - Kernel service commands            crate::app::core::kernel_service::start_kernel,            crate::app::core::kernel_service::stop_kernel,            crate::app::core::kernel_service::restart_kernel,            crate::app::core::kernel_service::download_latest_kernel,            crate::app::core::kernel_service::check_kernel_version,            crate::app::core::kernel_service::start_websocket_relay,

            // Network - Subscription service commands
            crate::app::network::download_subscription,
            crate::app::network::add_manual_subscription,
            crate::app::network::get_current_config,
            crate::app::network::toggle_proxy_mode,
            crate::app::network::get_current_proxy_mode,

            // System - System service commands
            crate::app::system::check_admin,
            crate::app::system::restart_as_admin,
            crate::app::system::exit_application,
            crate::app::system::install_service,
            crate::app::system::uninstall_service,
            crate::app::system::check_service_status,

            // System - Update service commands
            crate::app::system::check_update,
            crate::app::system::download_and_install_update,

            // System - Config service commands
            crate::app::system::get_port_config,
            crate::app::system::update_port_config,

            // Core - Proxy service commands
            crate::app::proxy_service::set_system_proxy,
            crate::app::proxy_service::set_manual_proxy,
            crate::app::proxy_service::set_tun_proxy,
            crate::app::proxy_service::toggle_ip_version,
            crate::app::proxy_service::get_api_token,
            crate::app::proxy_service::get_proxies,
            crate::app::proxy_service::change_proxy,
            crate::app::proxy_service::test_node_delay,
            crate::app::proxy_service::test_group_delay,
            crate::app::proxy_service::get_version_info,
            crate::app::proxy_service::get_rules,
        ])
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}

fn show_window(app: &AppHandle) {
    let windows = app.webview_windows();

    windows
        .values()
        .next()
        .expect("Sorry, no window found")
        .set_focus()
        .expect("Can't Bring Window to Focus");
}
